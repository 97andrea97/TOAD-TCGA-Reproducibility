FROM ubuntu:22.04 as builder
WORKDIR /app

RUN apt-get update && apt-get install -y --no-install-recommends \
    bash python3.10 python3-dev python3-pip git gcc \
    libglib2.0-0 libsm6 libxext6 libxrender-dev libgl1-mesa-glx \
    openslide-tools \
    && ln -s /usr/bin/python3.10 /usr/bin/python \
    && rm -rf /var/lib/apt/lists/*

RUN python -m pip install --upgrade pip

# Keep versions aligned with your previous image
RUN pip install timm==0.9.8
RUN pip install torch==1.11.0+cu113 torchvision==0.12.0+cu113 -f https://download.pytorch.org/whl/torch_stable.html
RUN pip install pandas PyYAML opencv-python-headless matplotlib scikit-learn scipy tqdm h5py tensorboardX openslide-python "numpy<2"
RUN pip install git+https://github.com/oval-group/smooth-topk.git

RUN pip freeze --all > /opt/requirements-lock.txt

FROM ubuntu:22.04
WORKDIR /app

RUN apt-get update && apt-get install -y --no-install-recommends \
    bash python3.10 python3-pip \
    libglib2.0-0 libsm6 libxext6 libxrender-dev libgl1-mesa-glx \
    openslide-tools \
    && ln -s /usr/bin/python3.10 /usr/bin/python \
    && rm -rf /var/lib/apt/lists/*

COPY --from=builder /usr/local /usr/local
COPY --from=builder /usr/lib/python3/dist-packages /usr/lib/python3/dist-packages
COPY --from=builder /opt/requirements-lock.txt /opt/requirements-lock.txt

RUN mkdir -p /app/TOAD_repo

ENTRYPOINT ["/bin/bash"]
